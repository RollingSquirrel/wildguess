@if (roomState(); as room) {
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-bg-secondary border-b border-border">
      <div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-4">
          <h1 class="text-lg font-bold truncate">{{ room.name }}</h1>
          <button
            (click)="copyRoomCode()"
            class="font-mono text-xs bg-bg-primary border border-border text-text-secondary py-0.5 px-2.5 rounded-md cursor-pointer transition-all duration-150 hover:border-primary hover:text-primary"
            [attr.aria-label]="'Copy room code ' + room.id"
            title="Click to copy"
          >
            {{ room.id }}
          </button>
          <wg-badge [variant]="asBadgeVariant('phase-' + room.phase)">{{ room.phase }}</wg-badge>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-text-secondary text-sm">Round {{ room.round }}</span>
          <button
            wgButton
            variant="danger-ghost"
            (click)="leaveRoom()"
            class="text-sm"
            aria-label="Leave room"
          >
            Leave
          </button>
        </div>
      </div>

      <!-- Topic bar -->
      @if (room.currentTopic) {
        <div class="py-2 bg-bg-primary border-b border-border">
          <div class="max-w-6xl mx-auto px-4">
            <span class="text-text-muted text-xs uppercase tracking-wider mr-2">Topic</span>
            <span class="text-text-primary text-sm">{{ room.currentTopic }}</span>
          </div>
        </div>
      }
    </header>

    <!-- Main content -->
    <div class="flex-1 max-w-6xl mx-auto w-full px-4 py-6">
      <div class="grid gap-6 grid-cols-1 md:grid-cols-[1fr_220px]">
        <!-- Main area -->
        <div class="main-area">
          @if (error()) {
            <wg-error-banner>{{ error() }}</wg-error-banner>
          }

          <!-- Host controls -->
          @if (isHost()) {
            <div class="bg-bg-surface border border-border rounded-xl p-4 mb-6">
              @if (phase() === 'voting') {
                <form [formGroup]="topicForm" (ngSubmit)="setTopic()" class="flex gap-2 mb-3">
                  <input
                    id="topic-input"
                    type="text"
                    formControlName="topic"
                    class="input-field-sm flex-1"
                    placeholder="Set topic for this round..."
                    aria-label="Topic for this round"
                  />
                  <button
                    wgButton
                    variant="sm"
                    type="submit"
                    [disabled]="topicForm.invalid || isUpdating()"
                  >
                    Set
                  </button>
                </form>

                <button
                  (click)="reveal()"
                  [class]="
                    'w-full py-3 border-none rounded-[10px] font-semibold text-[0.9rem] cursor-pointer transition-all duration-300 relative overflow-hidden disabled:opacity-40 disabled:cursor-not-allowed ' +
                    (allVoted()
                      ? 'bg-primary text-bg-primary animate-pulse-glow hover:shadow-[0_0_30px_var(--color-primary-glow)]'
                      : 'bg-bg-surface-hover text-text-secondary')
                  "
                  [disabled]="isUpdating()"
                >
                  @if (!allVoted() && votingProgressPercent() > 0) {
                    <div
                      class="absolute top-0 left-0 bottom-0 bg-primary opacity-20 transition-all duration-300 ease-out z-0"
                      [style.width.%]="votingProgressPercent()"
                    ></div>
                  }
                  <span class="relative z-10 block pointer-events-none">
                    @if (allVoted()) {
                      ‚ú® Reveal Votes
                    } @else {
                      Reveal Votes Early ({{ votedCount() }}/{{ members().length }})
                    }
                  </span>
                </button>
              }

              @if (phase() === 'revealed') {
                <button
                  (click)="triggerVersus()"
                  class="w-full py-3 border-none rounded-[10px] font-semibold text-[0.9rem] cursor-pointer transition-all duration-300 text-[#1a1a2e] bg-[linear-gradient(135deg,#ff6b35,#ffaa00)] hover:shadow-[0_0_30px_rgba(255,170,0,0.3)] disabled:opacity-40 disabled:cursor-not-allowed"
                  [disabled]="isUpdating()"
                >
                  ‚öîÔ∏è Versus Mode
                </button>
              }

              @if (phase() === 'versus') {
                <button
                  (click)="nextRound()"
                  class="w-full py-3 border-none rounded-[10px] font-semibold text-[0.9rem] cursor-pointer transition-all duration-300 bg-primary text-bg-primary hover:shadow-[0_0_30px_var(--color-primary-glow)] disabled:opacity-40 disabled:cursor-not-allowed"
                  [disabled]="isUpdating()"
                >
                  üîÑ Next Round
                </button>
              }
            </div>
          }

          <!-- VOTING PHASE -->
          @if (phase() === 'voting') {
            <div class="animate-slide-up-slow" [class.animate-phase-enter]="phaseAnimating()">
              <h2 class="text-lg font-semibold text-text-secondary mb-5">Cast Your Vote</h2>
              <div class="grid gap-2.5 grid-cols-[repeat(auto-fill,minmax(72px,1fr))]">
                @for (value of fibValues; track value) {
                  <app-vote-card
                    [value]="value"
                    [selected]="selectedVote() === value"
                    [disabled]="isUpdating()"
                    (clicked)="selectVote(value)"
                  />
                }
              </div>
            </div>
          }

          <!-- REVEALED PHASE -->
          @if (phase() === 'revealed') {
            <div class="animate-slide-up-slow" [class.animate-phase-enter]="phaseAnimating()">
              <h2 class="text-lg font-semibold text-text-secondary mb-5">Results</h2>

              <div class="flex gap-6 items-start max-[600px]:flex-col">
                <!-- Left: Results table + stats -->
                <div class="flex-1 min-w-0">
                  <!-- Results table -->
                  <div class="flex flex-col gap-1.5 mb-5">
                    @for (member of members(); track member.userId; let i = $index) {
                      <div
                        class="flex items-center gap-2.5 bg-bg-surface border border-border rounded-[10px] py-2.5 px-3.5 animate-result-slide-in"
                        [style.animation-delay.ms]="i * 80"
                      >
                        <div
                          class="size-[30px] rounded-full bg-bg-primary border-2 border-primary flex items-center justify-center text-xs font-bold text-primary shrink-0"
                        >
                          {{ member.username.charAt(0).toUpperCase() }}
                        </div>
                        <div
                          class="flex-1 text-[0.85rem] font-medium text-text-primary truncate min-w-0"
                        >
                          {{ member.username }}
                        </div>
                        <div
                          class="text-xl font-extrabold text-primary min-w-10 text-center shrink-0"
                        >
                          {{ member.vote ?? '‚Äì' }}
                        </div>
                        @if (stats() && member.vote && member.vote !== '?') {
                          <div
                            class="flex-1 h-1.5 bg-bg-primary rounded-sm overflow-hidden min-w-10 max-w-30"
                          >
                            <div
                              class="h-full rounded-sm bg-[linear-gradient(90deg,var(--color-primary),var(--color-primary-dim))] shadow-[0_0_6px_var(--color-primary-glow)]"
                              [style.width.%]="(+member.vote / stats()!.max) * 100"
                              [style.transition]="'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)'"
                            ></div>
                          </div>
                        }
                      </div>
                    }
                  </div>

                  <!-- Large readable stats -->
                  @if (stats(); as s) {
                    <div class="flex gap-2 flex-wrap">
                      <div
                        class="flex-1 min-w-[70px] bg-bg-surface border border-border rounded-[10px] py-3 px-2 text-center animate-slide-up-slow [animation-fill-mode:both]"
                      >
                        <span class="block text-2xl font-extrabold text-primary leading-tight">{{
                          s.average
                        }}</span>
                        <span
                          class="block text-[0.65rem] font-semibold text-text-muted uppercase tracking-wide mt-0.5"
                          >Avg</span
                        >
                      </div>
                      <div
                        class="flex-1 min-w-[70px] bg-bg-surface border border-border rounded-[10px] py-3 px-2 text-center animate-slide-up-slow [animation-fill-mode:both]"
                      >
                        <span class="block text-2xl font-extrabold text-primary leading-tight">{{
                          s.median
                        }}</span>
                        <span
                          class="block text-[0.65rem] font-semibold text-text-muted uppercase tracking-wide mt-0.5"
                          >Median</span
                        >
                      </div>
                      <div
                        class="flex-1 min-w-[70px] bg-bg-surface border-[rgba(0,230,118,0.2)] border rounded-[10px] py-3 px-2 text-center animate-slide-up-slow [animation-fill-mode:both]"
                      >
                        <span class="block text-2xl font-extrabold text-primary leading-tight">{{
                          s.min
                        }}</span>
                        <span
                          class="block text-[0.65rem] font-semibold text-text-muted uppercase tracking-wide mt-0.5"
                          >Min</span
                        >
                      </div>
                      <div
                        class="flex-1 min-w-[70px] bg-bg-surface border-[rgba(0,230,118,0.2)] border rounded-[10px] py-3 px-2 text-center animate-slide-up-slow [animation-fill-mode:both]"
                      >
                        <span class="block text-2xl font-extrabold text-primary leading-tight">{{
                          s.max
                        }}</span>
                        <span
                          class="block text-[0.65rem] font-semibold text-text-muted uppercase tracking-wide mt-0.5"
                          >Max</span
                        >
                      </div>
                    </div>
                  }
                </div>

                <!-- Right: Donut chart -->
                @if (stats(); as s) {
                  <div class="shrink-0 pt-2 max-[600px]:self-center">
                    <app-donut-chart [distribution]="s.distribution" [totalVotes]="s.totalVotes" />
                  </div>
                }
              </div>
            </div>
          }

          <!-- VERSUS PHASE -->
          @if (phase() === 'versus') {
            <div class="animate-slide-up-slow" [class.animate-phase-enter]="phaseAnimating()">
              @if (versus(); as v) {
                <div
                  class="flex items-center justify-center gap-6 py-8 flex-wrap animate-versus-enter"
                >
                  <!-- Low voter -->
                  <div class="text-center flex-1 max-w-[180px] min-w-[100px]">
                    <div
                      class="w-[100px] h-[140px] mx-auto mb-3 flex items-center justify-center rounded-2xl border-2 relative border-info animate-fighter-pulse bg-[linear-gradient(135deg,rgba(64,196,255,0.1),rgba(64,196,255,0.02))] shadow-[0_0_30px_rgba(64,196,255,0.15)]"
                    >
                      <div class="text-4xl font-extrabold text-info">{{ v.low.vote }}</div>
                    </div>
                    <div class="text-[0.9rem] font-semibold text-text-primary mb-1">
                      {{ v.low.username }}
                    </div>
                    <div class="text-[0.65rem] text-text-muted uppercase tracking-wide">
                      Lower Estimate
                    </div>
                  </div>

                  <!-- VS badge -->
                  <div
                    class="shrink-0 size-[60px] flex items-center justify-center rounded-full animate-vs-pulse bg-[linear-gradient(135deg,var(--color-danger),#ff6b35)] shadow-[0_0_30px_rgba(255,77,106,0.3)]"
                  >
                    <span class="text-xl font-black text-white tracking-widest">VS</span>
                  </div>

                  <!-- High voter -->
                  <div class="text-center flex-1 max-w-[180px] min-w-[100px]">
                    <div
                      class="w-[100px] h-[140px] mx-auto mb-3 flex items-center justify-center rounded-2xl border-2 relative border-warning bg-[linear-gradient(135deg,rgba(255,170,0,0.1),rgba(255,170,0,0.02))] shadow-[0_0_30px_rgba(255,170,0,0.15)]"
                      [style.animation]="'fighter-pulse 2s infinite alternate 0.5s'"
                    >
                      <div class="text-4xl font-extrabold text-warning">{{ v.high.vote }}</div>
                    </div>
                    <div class="text-[0.9rem] font-semibold text-text-primary mb-1">
                      {{ v.high.username }}
                    </div>
                    <div class="text-[0.65rem] text-text-muted uppercase tracking-wide">
                      Higher Estimate
                    </div>
                  </div>
                </div>

                <p class="text-center text-text-secondary text-[0.85rem] mt-4 opacity-80 w-full">
                  Time for discussion! The most extreme voters explain their reasoning.
                </p>
              } @else {
                <div class="text-center py-12 text-text-muted">
                  All votes are the same ‚Äî consensus reached! üéâ
                </div>
              }

              <!-- Stats still visible -->
              @if (stats(); as s) {
                <div class="flex gap-2 flex-wrap mt-8 mx-auto max-w-sm">
                  <div
                    class="flex-1 min-w-[70px] bg-bg-surface border border-border rounded-[10px] py-3 px-2 text-center animate-slide-up-slow [animation-fill-mode:both]"
                  >
                    <span class="block text-2xl font-extrabold text-primary leading-tight">{{
                      s.average
                    }}</span>
                    <span
                      class="block text-[0.65rem] font-semibold text-text-muted uppercase tracking-wide mt-0.5"
                      >Avg</span
                    >
                  </div>
                  <div
                    class="flex-1 min-w-[70px] bg-bg-surface border border-border rounded-[10px] py-3 px-2 text-center animate-slide-up-slow [animation-fill-mode:both]"
                  >
                    <span class="block text-2xl font-extrabold text-primary leading-tight">{{
                      s.median
                    }}</span>
                    <span
                      class="block text-[0.65rem] font-semibold text-text-muted uppercase tracking-wide mt-0.5"
                      >Median</span
                    >
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- Sidebar: Members -->
        <aside
          class="bg-bg-surface border border-border rounded-xl p-4 h-fit sticky top-4"
          aria-label="Room members"
        >
          <h2 class="text-sm font-semibold text-text-secondary uppercase tracking-wider mb-3">
            Members ({{ members().length }})
          </h2>
          <ul class="list-none m-0 p-0 flex flex-col gap-2">
            @for (member of members(); track member.userId) {
              <li
                class="flex items-center justify-between p-2 rounded-lg transition-colors duration-150 hover:bg-bg-surface-hover"
              >
                <div class="flex items-center gap-2 min-w-0">
                  <div
                    class="size-8 rounded-full bg-bg-primary border-2 flex items-center justify-center text-[0.8rem] font-bold shrink-0 transition-all duration-300"
                    [class.border-border]="!member.hasVoted"
                    [class.text-text-secondary]="!member.hasVoted"
                    [class.border-primary]="member.hasVoted"
                    [class.text-primary]="member.hasVoted"
                    [style.box-shadow]="
                      member.hasVoted ? '0 0 8px var(--color-primary-glow)' : null
                    "
                  >
                    {{ member.username.charAt(0).toUpperCase() }}
                  </div>
                  <div class="min-w-0">
                    <div class="text-[0.85rem] font-medium text-text-primary truncate">
                      {{ member.username }}
                      @if (member.isHost) {
                        <span aria-label="Host" title="Host">üëë</span>
                      }
                      @if (member.userId === currentUserId()) {
                        <span class="ml-1 text-[0.7rem] font-normal text-text-muted">(you)</span>
                      }
                    </div>
                    @if (phase() === 'voting') {
                      <div
                        class="text-[0.7rem]"
                        [class.text-text-muted]="!member.hasVoted"
                        [class.text-primary]="member.hasVoted"
                      >
                        {{ member.hasVoted ? '‚úì Voted' : 'Thinking...' }}
                      </div>
                    }
                  </div>
                </div>
                @if (isHost() && member.userId !== currentUserId()) {
                  <button
                    (click)="kickMember(member.userId)"
                    class="size-6 flex items-center justify-center border-none bg-transparent text-text-muted rounded-md text-xs cursor-pointer shrink-0 transition-all duration-150 hover:bg-danger-subtle hover:text-danger"
                    [attr.aria-label]="'Kick ' + member.username"
                    title="Kick member"
                    [disabled]="isUpdating()"
                  >
                    ‚úï
                  </button>
                }
              </li>
            }
          </ul>
        </aside>
      </div>
    </div>
  </div>
} @else {
  <div class="min-h-screen flex items-center justify-center">
    <div class="text-text-muted">Loading room...</div>
  </div>
}
